---
title: "Sample Size - Grand Bassa Stepped Wedge"
output: word_document
editor_options:
  chunk_output_type: console
---



# Load packages
```{r warning=FALSE, message=FALSE}

# devtools::install_github("Avi-Kenny/simba")

# Load libraries
library(parallel)
library(ggplot2)
library(readxl)
library(magrittr)
library(dplyr)
library(simba)
library(tibble)
library(rlist)

```



# Simulation setup
```{r}

# Load functions
# Note: if running this locally in RStudio, you may need to click "Session" >> "Set Working Directory" >> "To Source File Location"
source("R/helpers.R")
source("R/create_dataset.R")
source("R/birth_history.R")
source("R/perform_analysis.R")
source("R/take_sample.R")

sim <- new_sim()

sim %<>% set_config(
  num_sim = 10,
  datasets = "many",
  parallel = "outer",
  packages = c("magrittr", "dplyr", "tibble", "rlist")
)

sim %<>% set_levels(
  "sample_size" = c(10, 100, 1000)
)

sim %<>% add_constants(
  "sampling_frame" = read_excel(
    "data/GrandBassa2020SamplingFrame_truncated.xlsx"
  ) %>%
    rowid_to_column("community_id") %>%
    rename(
      'num_hh' = `numHH`,
      'health_district' = `map_health_district`,
      'admin_district' = `map_adm_distri`
    )
)

# Add necessary functions
sim %<>% add_creator(create_dataset)
sim %<>% add_method(baseline_u5mr)
sim %<>% add_method(dates_to_cmc)
sim %<>% add_method(cmc_to_dates)
sim %<>% add_method(birth_history)
sim %<>% add_method(take_sample)
sim %<>% add_method(perform_analysis)

sim %<>% add_script(
  "script_1",
  function(L, C) {
    
    # Generate population
    dataset <- create_dataset(
      "sampling_frame" = C$sampling_frame,
      "program_effect" = 0.25
    )
    
    # Take a sample from population
    sample <- take_sample(
      "population" = dataset,
      "sampling_frame" = C$sampling_frame,
      "n_clusters" = L$sample_size
    )
    
    # Perform statistical analysis and return result of hypothesis test
    reject_h0 <- perform_analysis(
      "sample" = sample,
      "type" = 1
    )
    
    return (list(
      "reject_h0" = reject_h0
    ))
    
  }
)

```



# Run simulation
```{r}

# Run simulation
results <- sim %>% run("script_1")

# Summarize results
summary(results, sd=TRUE)

```
